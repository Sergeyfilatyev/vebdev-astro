---
import BlockRenderer from '@/components/BlockRenderer.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';

interface Page {
	title: string;
	slug: string;
	blocks: any[];
	locale: string;
}

interface Props {
	page: Page;
	header?: any;
	footer?: any;
	settings?: any; // Глобальные настройки
	locale: string;
}

export async function getStaticPaths() {
	const langs = ['en', 'ru', 'uk'];
	const defaultLang = 'uk';
	const cmsUrl = import.meta.env.CMS_URL || 'http://localhost:3000';
	const paths: any = [];

	const globalsData: any = {};

	// 1. Получение Глобальных настроек (Header, Footer, Settings)
	for (const lang of langs) {
		try {
			// Получаем GeneralSettings
			const settingsResponse = await fetch(
				`${cmsUrl}/api/globals/general-settings?locale=${lang}`
			);
			const settingsData = settingsResponse.ok
				? await settingsResponse.json()
				: null;

			globalsData[lang] = {
				settings: settingsData, // Сохраняем настройки
			};
		} catch (e) {
			console.error(`[Error] Could not fetch globals for ${lang}:`, e);
		}
	}

	// 2. Получение Страниц и Генерация Путей
	for (const lang of langs) {
		try {
			const response = await fetch(
				`${cmsUrl}/api/pages?locale=${lang}&limit=1000`
			);

			if (!response.ok) {
				console.error(
					`[Payload CMS Error] Failed to fetch pages for locale: ${lang}`
				);
				continue; 
			}

			const data = await response.json();
			const pages = data.docs || [];

			if (pages.length > 0) {
				pages.forEach((page: any) => {
					const slugParts = [];
					if (lang !== defaultLang) {
						slugParts.push(lang);
					}
					if (page.slug && page.slug !== 'home') {
						slugParts.push(page.slug);
					}

					const slugString = slugParts.join('/');

					paths.push({
						params: {
							slug: slugString || undefined,
						},
						props: {
							page: {
								...page,
								locale: lang,
							},
							settings: globalsData[lang]?.settings, 
							locale: lang,
						},
					});
				});
			}
		} catch (e) {
			console.error(`[Error] Could not fetch data for ${lang}:`, e);
		}
	}
	return paths;
}

const {page, settings, locale} = Astro.props;
---

<BaseLayout
	title={page.title}
	settings={settings}
	locale={locale}>
	<BlockRenderer blocks={page.blocks} />
</BaseLayout>
