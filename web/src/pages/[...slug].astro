---
import BlockRenderer from '@/components/BlockRenderer.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';

interface Page {
	title: string;
	slug: string;
	blocks: any[];
	locale: string;
}

interface Props {
	page: Page;
	header?: any;
	footer?: any;
	locale: string;
}

export async function getStaticPaths() {
	// 1. Переменные внутри функции (как мы и договорились)
	const langs = ['en', 'ru', 'uk'];
	const defaultLang = 'uk';
	const cmsUrl = import.meta.env.CMS_URL || 'http://localhost:3000';

	const paths: any = [];

	// Получаем глобальные данные для всех языков
	const globalsData: any = {};

	for (const lang of langs) {
		try {
			// Получаем header
			const headerResponse = await fetch(
				`${cmsUrl}/api/globals/header?locale=${lang}`
			);
			const headerData = headerResponse.ok ? await headerResponse.json() : null;

			// Получаем footer
			const footerResponse = await fetch(
				`${cmsUrl}/api/globals/footer?locale=${lang}`
			);
			const footerData = footerResponse.ok ? await footerResponse.json() : null;

			globalsData[lang] = {
				header: headerData,
				footer: footerData,
			};
		} catch (e) {
			console.error(`[Error] Could not fetch globals for ${lang}:`, e);
		}
	}

	for (const lang of langs) {
		try {
			const response = await fetch(
				`${cmsUrl}/api/pages?locale=${lang}&limit=1000`
			);

			if (!response.ok) {
				console.error(
					`[Payload CMS Error] Failed to fetch pages for locale: ${lang}`
				);
				continue;
			}

			const {docs: pages} = await response.json();

			pages.forEach((page: any) => {
				const slugParts = [];
				if (lang !== defaultLang) {
					slugParts.push(lang);
				}
				if (page.slug && page.slug !== 'home') {
					slugParts.push(page.slug);
				}
				const slugString = slugParts.join('/');

				paths.push({
					params: {
						slug: slugString || undefined,
					},
					props: {
						page: {
							...page,
							locale: lang,
						},
						header: globalsData[lang]?.header,
						footer: globalsData[lang]?.footer,
						locale: lang,
					},
				});
			});
		} catch (e) {
			console.error(`[Error] Could not fetch data for ${lang}:`, e);
		}
	}
	return paths;
}

const {page, header, footer, locale} = Astro.props;
---

<BaseLayout
	title={page.title}
	header={header}
	footer={footer}
	locale={locale}>
	<BlockRenderer blocks={page.blocks} />
</BaseLayout>
